#!/usr/bin/env node

/**
 * Module dependencies.
 */

var program = require('commander');
var TwitBot = require('../lib/twitbot');
var jf = require('jsonfile');

program
	.option('-t --twittercfg <path>', 'twitter credetinals configuration file')
	.option('-r --repo <string>', 'which repository to open')
	.option('-c --repocfg <path>', 'repository configuration file')
	.option('-k --keywords "<string>"', 'comma separated keywords to search')
	.option('-b --batch <number>', 'twitter search batch size')
	.option('-i --interval <number>', 'twitter search interval window in seconds')
	.parse(process.argv);

// Ensure required parameters are set
if (!program.twittercfg)
	throw new Error('Twitter credentials configuration file not set.');

if (!program.repo)
	throw new Error('Repository not set.');

if (!program.repocfg)
	throw new Error('Repository configuration file not set.');

if (!program.keywords)
	throw new Error('No keywords set.');

jf.readFile(program.twittercfg, function(err, twitterConfig){
	if (err) throw new Error('Could no\'t open twitter credentials file.');

	// Instantiate twitbot
	var bot = new TwitBot(twitterConfig);

	jf.readFile(program.repocfg, function(err, repoConfig) {
		if (err) throw new Error('Could no\'t open repository configuration file.');

		if (program.batch && program.batch > 0)
			bot.setBatchSize(program.batch);

		if (program.interval && program.interval > 0)
			bot.setSearchInterval(program.interval);

		// Open repository
		bot.setRepository(program.repo, repoConfig);

		bot.start({
			q: program.keywords
		});
	})
});